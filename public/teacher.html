<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher | Smart Attendance</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>
  <body>
    <div class="page-wrapper">
      <!-- Animated Background Elements -->
      <div class="bg-decoration">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
      </div>

      <header class="page-header fade-in">
        <div class="page-header-left">
          <div class="avatar-container teacher-avatar">
            <div class="avatar-glow"></div>
            <div class="avatar-icon" style="font-size: 2.5rem;">
              üë®‚Äçüè´
            </div>
            <div class="avatar-status">
              <span class="status-dot"></span>
            </div>
          </div>
          <div>
            <h1>
              <span class="emoji">üë®‚Äçüè´</span>
              Smart Attendance
            </h1>
            <p class="subtitle">
              <i class="fa-solid fa-location-dot"></i>
              Create geo-fenced, time-bound attendance sessions
            </p>
          </div>
        </div>
        <div class="page-header-right">
          <span class="badge badge-live pulse">
            <span class="dot"></span>
            Live session
          </span>
        </div>
      </header>

      <main class="cards-grid">
        <section class="card elevate slide-up">
          <div class="card-header-icon">
            <i class="fa-solid fa-magic"></i>
          </div>
          <h2 class="card-title">
            <span class="emoji">‚ú®</span>
            Create new session
          </h2>
          <p class="card-description">
            Enter your details and capture your GPS location. Students within 120 meters can mark
            attendance using the generated link. Multiple sessions can run simultaneously.
          </p>

          <form id="sessionForm" class="form-grid">
            <label class="input-group">
              <span class="input-label">
                <i class="fa-solid fa-user-tie"></i>
                Teacher name
              </span>
              <input
                type="text"
                id="teacherName"
                placeholder="e.g. Prof. Sharma"
                required
                autocomplete="name"
              />
            </label>
            <label class="input-group">
              <span class="input-label">
                <i class="fa-solid fa-book"></i>
                Subject
              </span>
              <input
                type="text"
                id="subject"
                placeholder="e.g. Data Structures"
                required
                autocomplete="off"
              />
            </label>

            <div class="location-card">
              <div class="location-header">
                <i class="fa-solid fa-map-marker-alt"></i>
                <span>Location Setup</span>
              </div>
              <div class="location-row">
                <button type="button" id="getLocation" class="btn-outline btn-location">
                  <i class="fa-solid fa-location-arrow"></i>
                  <span>Capture Location</span>
                </button>
                <div class="location-status-wrapper">
                  <span id="locationStatus" class="location-status">
                    <i class="fa-solid fa-clock"></i>
                    Location not set
                  </span>
                </div>
              </div>
            </div>

            <input type="hidden" id="lat" />
            <input type="hidden" id="lng" />

            <button type="submit" class="btn-primary w-full btn-submit">
              <span>Create Session</span>
              <i class="fa-solid fa-arrow-right"></i>
            </button>
          </form>
        </section>

        <section id="result" class="card elevate slide-up delay hidden result-card">
          <div class="card-header-icon success-icon">
            <i class="fa-solid fa-check-circle"></i>
          </div>
          <h2 class="card-title">
            <span class="emoji">üéØ</span>
            Session created!
          </h2>

          <div class="session-meta">
            <div class="meta-item">
              <span class="meta-label">
                <i class="fa-solid fa-key"></i>
                Session Code
              </span>
              <p class="meta-value code-pill" id="code"></p>
            </div>
            <div class="meta-item">
              <span class="meta-label">
                <i class="fa-solid fa-clock"></i>
                Expires at
              </span>
              <p class="meta-value" id="expiresAt"></p>
            </div>
          </div>

          <div class="session-link">
            <span class="meta-label">
              <i class="fa-solid fa-link"></i>
              Student Link
            </span>
            <div class="link-row">
              <a id="link" href="#" target="_blank" class="link-chip"></a>
              <button id="copyLink" type="button" class="icon-button" title="Copy link">
                <i class="fa-regular fa-copy"></i>
              </button>
            </div>
          </div>

          <div class="export-section">
            <div class="export-header">
              <span class="meta-label">
                <i class="fa-solid fa-download"></i>
                Export Attendance
              </span>
              <span class="export-subject-label" id="exportSubjectLabel"></span>
            </div>
            <div class="export-buttons">
              <button
                type="button"
                class="btn-chip export-btn"
                onclick="downloadExport('csv')"
                title="Download CSV"
              >
                <i class="fa-solid fa-file-csv"></i>
                <span>CSV</span>
              </button>
              <button
                type="button"
                class="btn-chip export-btn success"
                onclick="downloadExport('excel')"
                title="Download Excel"
              >
                <i class="fa-solid fa-file-excel"></i>
                <span>Excel</span>
              </button>
              <button
                type="button"
                class="btn-chip export-btn danger"
                onclick="downloadExport('pdf')"
                title="Download PDF"
              >
                <i class="fa-solid fa-file-pdf"></i>
                <span>PDF</span>
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      const sessionForm = document.getElementById('sessionForm');
      const getLocationBtn = document.getElementById('getLocation');
      const locationStatus = document.getElementById('locationStatus');
      const latInput = document.getElementById('lat');
      const lngInput = document.getElementById('lng');
      const resultSection = document.getElementById('result');
      const codeSpan = document.getElementById('code');
      const linkAnchor = document.getElementById('link');
      const expiresSpan = document.getElementById('expiresAt');
      const copyBtn = document.getElementById('copyLink');
      const subjectInput = document.getElementById('subject');
      const exportSubjectLabel = document.getElementById('exportSubjectLabel');

      const getLocation = () => {
        if (!navigator.geolocation) {
          locationStatus.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Geolocation not supported';
          return;
        }

        locationStatus.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Fetching location...';
        getLocationBtn.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            latInput.value = latitude;
            lngInput.value = longitude;
            locationStatus.innerHTML = `<i class="fa-solid fa-check-circle"></i> Captured: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
            locationStatus.classList.add('success-status');
            getLocationBtn.innerHTML = '<i class="fa-solid fa-check"></i> <span>Location Captured</span>';
            getLocationBtn.classList.add('success');
          },
          () => {
            locationStatus.innerHTML = '<i class="fa-solid fa-times-circle"></i> Unable to fetch location';
            locationStatus.classList.add('error-status');
            getLocationBtn.disabled = false;
          },
          { enableHighAccuracy: true }
        );
      };

      getLocationBtn.addEventListener('click', getLocation);

      sessionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!latInput.value || !lngInput.value) {
          alert('‚ö†Ô∏è Please capture your location first.');
          return;
        }

        const submitBtn = sessionForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';

        try {
          const response = await fetch('/api/teacher/session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              teacherName: document.getElementById('teacherName').value,
              subject: document.getElementById('subject').value,
              lat: Number(latInput.value),
              lng: Number(lngInput.value),
            }),
          });

          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.message || 'Unable to create session');
          }

          const data = await response.json();
          codeSpan.textContent = data.code;
          linkAnchor.textContent = data.link;
          linkAnchor.href = data.link;
          expiresSpan.textContent = new Date(data.expiresAt).toLocaleString();
          exportSubjectLabel.textContent = `(${subjectInput.value.trim()})`;
          resultSection.classList.remove('hidden');
          resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (error) {
          alert('‚ùå ' + error.message);
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span>Create Session</span> <i class="fa-solid fa-arrow-right"></i>';
        }
      });

      copyBtn.addEventListener('click', async () => {
        if (!linkAnchor.href) return;
        try {
          await navigator.clipboard.writeText(linkAnchor.href);
          const icon = copyBtn.querySelector('i');
          icon.className = 'fa-solid fa-check';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            icon.className = 'fa-regular fa-copy';
            copyBtn.classList.remove('copied');
          }, 2000);
        } catch (err) {
          alert('Failed to copy link');
        }
      });

      function downloadExport(type) {
        const subject = subjectInput.value.trim();
        const base = `/api/export/${type}`;
        const url = subject ? `${base}?subject=${encodeURIComponent(subject)}` : base;
        window.location = url;
      }
    </script>

    <footer style="text-align: center; padding: 20px; color: rgba(255, 255, 255, 0.8); font-size: 14px; margin-top: 40px;">
      Created by <strong style="color: #fff;">MALLIKARJUN</strong>
    </footer>
  </body>
</html>
